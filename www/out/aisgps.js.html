<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: aisgps.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: aisgps.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** Global AIS datas */
let aisData = null;

/** Global layer group to manage AIS markers */
let aisLayer = null;

/** The current GPS marker */
let gpsMarker = null;

/** Array of GPS coordinates for the track */
let gpsTrack = [];

/** The polyline showing the GPS track */
let gpsPolyline = null;

/**
 * Displays the current GPS position on the map.
 * Updates the marker, popup, and the track polyline.
 * 
 * @param {Object} gpsData - The GPS data in JSON format.
 * @param {number} gpsData.lat - Latitude in decimal.
 * @param {number} gpsData.lon - Longitude in decimal.
 * @param {string} gpsData.time - UTC time string.
 * @param {number} [gpsData["alt M"]] - Altitude in meters (optional).
 * @param {number} gpsData.sog - Speed over ground.
 * @param {number} gpsData.cog - Course over ground.
 * @param {number} gpsData.numSat - Number of satellites.
 */
function showBoatPosition (gpsData) {
   const lat = gpsData.lat;
   const lon = gpsData.lon;
   const dms = toDMSString (lat, lon);

   const altStr = gpsData["alt m"] !== undefined
      ? `Altitude: ${gpsData["alt m"]} m&lt;br>`
      : "";

   const popupContent = `
      &lt;b>GPS&lt;/b>&lt;br>
      Coordinates: ${dms}&lt;br>
      ${altStr}
      SOG: ${gpsData.sog} kn&lt;br>
      COG: ${gpsData.cog}°&lt;br>
      Satellites: ${gpsData.numSat}&lt;br>
      Time: ${gpsData.time}
   `;

   // Emoji icon for the marker
   const emojiIcon = L.divIcon({
      html: '📍',
      iconSize: [24, 24],
      className: 'gps-icon'
   });

   // Remove previous marker if exists
   if (gpsMarker) {
      map.removeLayer(gpsMarker);
   }
   if (gpsData.time === "NA" || gpsData.numSat &lt; 2)
      return;

   // Add new marker with popup
   gpsMarker = L.marker([lat, lon], { icon: emojiIcon })
      .addTo(map)
      .bindPopup(popupContent);
      //.openPopup();

   // Add point to GPS track
   gpsTrack.push([lat, lon]);

   // Update or create the polyline
   /*if (gpsPolyline) {
      gpsPolyline.setLatLngs(gpsTrack);
   } else {
      gpsPolyline = L.polyline(gpsTrack, { color: 'red' }).addTo(map);
   }*/
   // Optional: center the map on the position
   // map.setView([lat, lon]);
}

/**
 * Fetches the current GPS position from the local server.
 * Uses a timeout to prevent hanging if the server is unresponsive.
 */
function fetchGpsPosition() {
   const controller = new AbortController();
   const timeout = setTimeout(() => {
      controller.abort(); // Cancel request after 5s
   }, 5000);

   fetch (gpsUrl, {
      method: 'GET',
      signal: controller.signal
   })
   .then(response => {
      clearTimeout(timeout);
      console.log('Server response status:', response.status);
      if (!response.ok) {
         throw new Error(`HTTP error ${response.status}`);
      }
      return response.text(); // read as text first to see raw output
   })
   .then(text => {
      console.log('Raw response from server:', text);

      let data;
      try {
         data = JSON.parse(text);
      } catch (e) {
         console.error('Failed to parse JSON:', e.message);
         if (gpsMarker) map.removeLayer(gpsMarker);
         return;
      }

      console.log('Parsed JSON:', data);
      showBoatPosition(data);
   })
   .catch(err => {
      clearTimeout(timeout);
      console.error('Fetch error:', err.message);
      if (gpsMarker) map.removeLayer(gpsMarker);
   });
}

/**
 * Display AIS data in a Swal2 modal as a spreadsheet-like table.
 * @param {Object[]} aisData - Array of AIS objects to display.
 */
function aisDump (aisData) {
   if (aisData === null) {
      Swal.fire ('AIS Warning', 'No AIS Data', 'warning');
      return;
   }
   // Generate table headers
   const headers = ['Name', 'MessageID', 'Country', 'Min Dist', 'MMSI', 'Coordinate', 'SOG', 'COG', 'Last Update'];
  
   // Build table HTML
   let html = '&lt;div style="overflow-x:auto;">&lt;table style="width:100%; border-collapse:collapse; text-align:left;">';
   html += '&lt;thead>&lt;tr>';
   for (const header of headers) {
      html += `&lt;th style="border:1px solid #ccc; padding:4px;">${header}&lt;/th>`;
   }
   html += '&lt;/tr>&lt;/thead>&lt;tbody>';

   // Populate rows
   for (const item of aisData) {
      const cog = item.cog &lt; 0 ? item.cog + 360 : item.cog;
      html += '&lt;tr>';
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${item.name}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${item.messageId}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${item.country}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${item.mindist}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${item.mmsi}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${toDMSString (item.lat, item.lon)}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${item.sog.toFixed(2).toString().padStart(5, '0')}&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${cog.toString().padStart(3, '0')}°&lt;/td>`;
      html += `&lt;td style="border:1px solid #ccc; padding:4px;">${epochToStrDate(item.lastupdate)}&lt;/td>`;
      html += '&lt;/tr>';
   }

   html += '&lt;/tbody>&lt;/table>&lt;/div>';

   // Show with Swal2
   Swal.fire({
     title: 'AIS Dump',
     html: html,
     width: '80%',
     confirmButtonText: 'Close'
   });
}

/**
 * Show AIS targets on the Windy map, replacing previous ones.
 * @param {Object[]} aisData - Array of AIS data objects.
 */
function showAIS(aisData) {
   if (aisLayer) {
      map.removeLayer(aisLayer);
   }

   aisLayer = L.layerGroup();

   for (const boat of aisData) {
      if (boat.name === "_Unsupported") continue;
      const rotation = boat.cog; // Heading in degrees
      const isMoving = boat.sog > 0;

      // Triangle icon via divIcon + CSS transform
      const icon = L.divIcon({
         className: '', // no default class
         html: `
            &lt;div class="${isMoving ? 'ais-moving' : ''}" style="
            --cog: ${rotation}deg;
            width: 0; height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 18px solid orange;
            transform: rotate(${rotation}deg);
            transform-origin: center;
            ">&lt;/div>
            `,
         iconSize: [12, 12],
         iconAnchor: [6, 6]
      });

      const marker = L.marker([boat.lat, boat.lon], { icon });
      const cog = (boat.cog &lt; 0) ? boat.cog + 360 : boat.cog;
      const popupContent = `
         &lt;b>${boat.name}&lt;/b>&lt;br>
         Country: ${boat.country}&lt;br>
         MinDist: ${boat.mindist} Kn&lt;br>
         MMSI: ${boat.mmsi}&lt;br>
         Coordinate: ${toDMSString (boat.lat, boat.lon)}&lt;br>
         SOG: ${boat.sog.toFixed(2)} Kn&lt;br>
         COG: ${cog}°&lt;br>
         LastUpdate: ${epochToStrDate(boat.lastupdate)}
      `;

      marker.bindPopup(popupContent);
      aisLayer.addLayer(marker);
   }   
   aisLayer.addTo(map);
}

/**
 * Fetches the current AIS information from the local server.
 * Uses a timeout to prevent hanging if the server is unresponsive.
 */
function fetchAisPosition() {
   const controller = new AbortController();
   const timeout = setTimeout(() => {
      controller.abort(); // Cancel request after 5s
   }, 5000);

   fetch (aisUrl, {
      method: 'GET',
      signal: controller.signal
   })
   .then(response => {
      clearTimeout(timeout);
      console.log('Server response status:', response.status);
      if (!response.ok) {
         throw new Error(`HTTP error ${response.status}`);
      }
      return response.text(); // read as text first to see raw output
   })
   .then(text => {
      console.log('Raw response from server:', text);

      let data;
      try {
         data = JSON.parse(text);
      } catch (e) {
         console.error('Failed to parse JSON:', e.message);
         if (gpsMarker) map.removeLayer(gpsMarker);
         return;
      }

      console.log('Parsed JSON:', data);
      aisData = data;
      showAIS (data);
   })
   .catch(err => {
      clearTimeout(timeout);
      console.error('Fetch error:', err.message);
      if (gpsMarker) map.removeLayer(gpsMarker);
   });
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addMarker">addMarker</a></li><li><a href="global.html#addPOI">addPOI</a></li><li><a href="global.html#addWaypoint">addWaypoint</a></li><li><a href="global.html#aisData">aisData</a></li><li><a href="global.html#aisDump">aisDump</a></li><li><a href="global.html#aisLayer">aisLayer</a></li><li><a href="global.html#backWard">backWard</a></li><li><a href="global.html#bestVmg">bestVmg</a></li><li><a href="global.html#bestVmgBack">bestVmgBack</a></li><li><a href="global.html#buildBodyRequest">buildBodyRequest</a></li><li><a href="global.html#button4POI">button4POI</a></li><li><a href="global.html#changeParam">changeParam</a></li><li><a href="global.html#chooseFile">chooseFile</a></li><li><a href="global.html#chooseGrib">chooseGrib</a></li><li><a href="global.html#choosePolar">choosePolar</a></li><li><a href="global.html#clearRoutes">clearRoutes</a></li><li><a href="global.html#closeContextMenu">closeContextMenu</a></li><li><a href="global.html#condenseTimeStamps">condenseTimeStamps</a></li><li><a href="global.html#createProgressBar">createProgressBar</a></li><li><a href="global.html#dateToStr">dateToStr</a></li><li><a href="global.html#deleteAllPOIs">deleteAllPOIs</a></li><li><a href="global.html#deleteCompetitor">deleteCompetitor</a></li><li><a href="global.html#deleteCompetitorByName">deleteCompetitorByName</a></li><li><a href="global.html#deletePOI">deletePOI</a></li><li><a href="global.html#dispAllCompetitors">dispAllCompetitors</a></li><li><a href="global.html#dispBestTimeHistogram">dispBestTimeHistogram</a></li><li><a href="global.html#displayWayPoints">displayWayPoints</a></li><li><a href="global.html#dmsToDecimal">dmsToDecimal</a></li><li><a href="global.html#downloadTextFile">downloadTextFile</a></li><li><a href="global.html#drawGribLimits">drawGribLimits</a></li><li><a href="global.html#drawOrtho">drawOrtho</a></li><li><a href="global.html#drawPolyline">drawPolyline</a></li><li><a href="global.html#dumpFile">dumpFile</a></li><li><a href="global.html#dumpIsoDesc">dumpIsoDesc</a></li><li><a href="global.html#dumpIsoc">dumpIsoc</a></li><li><a href="global.html#dumpRoute">dumpRoute</a></li><li><a href="global.html#epochToStrDate">epochToStrDate</a></li><li><a href="global.html#escapeHtml">escapeHtml</a></li><li><a href="global.html#fPenalty">fPenalty</a></li><li><a href="global.html#fPointLoss">fPointLoss</a></li><li><a href="global.html#fTimeToRecupOnePoint">fTimeToRecupOnePoint</a></li><li><a href="global.html#feedback">feedback</a></li><li><a href="global.html#fetchAisPosition">fetchAisPosition</a></li><li><a href="global.html#fetchGpsPosition">fetchGpsPosition</a></li><li><a href="global.html#finalUpdate">finalUpdate</a></li><li><a href="global.html#findBounds">findBounds</a></li><li><a href="global.html#findMaxSpeed">findMaxSpeed</a></li><li><a href="global.html#forWard">forWard</a></li><li><a href="global.html#formatDuration">formatDuration</a></li><li><a href="global.html#formatDurationShort">formatDurationShort</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLocalDate">formatLocalDate</a></li><li><a href="global.html#generatePolarPlotly">generatePolarPlotly</a></li><li><a href="global.html#getGreatCirclePath">getGreatCirclePath</a></li><li><a href="global.html#getLocalUtcOffsetInSeconds">getLocalUtcOffsetInSeconds</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getSerializablePOIs">getSerializablePOIs</a></li><li><a href="global.html#getServerInit">getServerInit</a></li><li><a href="global.html#getTextColorFromLuminance">getTextColorFromLuminance</a></li><li><a href="global.html#goBegin">goBegin</a></li><li><a href="global.html#gpsMarker">gpsMarker</a></li><li><a href="global.html#gpsPolyline">gpsPolyline</a></li><li><a href="global.html#gpsTrack">gpsTrack</a></li><li><a href="global.html#gribInfo">gribInfo</a></li><li><a href="global.html#handleRequest">handleRequest</a></li><li><a href="global.html#helpInfo">helpInfo</a></li><li><a href="global.html#importCSV">importCSV</a></li><li><a href="global.html#interpolate">interpolate</a></li><li><a href="global.html#interpolateSpeeds">interpolateSpeeds</a></li><li><a href="global.html#lastStepDurationFormatted">lastStepDurationFormatted</a></li><li><a href="global.html#latLonToStr">latLonToStr</a></li><li><a href="global.html#launchRouting">launchRouting</a></li><li><a href="global.html#loadAppState">loadAppState</a></li><li><a href="global.html#loxoCap">loxoCap</a></li><li><a href="global.html#loxoDist">loxoDist</a></li><li><a href="global.html#manageCompetitors">manageCompetitors</a></li><li><a href="global.html#move">move</a></li><li><a href="global.html#newCompetitor">newCompetitor</a></li><li><a href="global.html#orthoCap">orthoCap</a></li><li><a href="global.html#orthoDist">orthoDist</a></li><li><a href="global.html#parDump">parDump</a></li><li><a href="global.html#polarInfo">polarInfo</a></li><li><a href="global.html#popup4Comp">popup4Comp</a></li><li><a href="global.html#refreshMarker">refreshMarker</a></li><li><a href="global.html#removeCompetitor">removeCompetitor</a></li><li><a href="global.html#replay">replay</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#requestAllCompetitors">requestAllCompetitors</a></li><li><a href="global.html#requestBestTime">requestBestTime</a></li><li><a href="global.html#requestOne">requestOne</a></li><li><a href="global.html#resetWaypoint">resetWaypoint</a></li><li><a href="global.html#saveAppState">saveAppState</a></li><li><a href="global.html#setBoat">setBoat</a></li><li><a href="global.html#showAIS">showAIS</a></li><li><a href="global.html#showBoatPosition">showBoatPosition</a></li><li><a href="global.html#showContextMenu">showContextMenu</a></li><li><a href="global.html#showDestination">showDestination</a></li><li><a href="global.html#showInitMessage">showInitMessage</a></li><li><a href="global.html#showPOI">showPOI</a></li><li><a href="global.html#showPolarTable">showPolarTable</a></li><li><a href="global.html#showRoute">showRoute</a></li><li><a href="global.html#showRouteReport">showRouteReport</a></li><li><a href="global.html#showWayPoint">showWayPoint</a></li><li><a href="global.html#simplify">simplify</a></li><li><a href="global.html#stamina">stamina</a></li><li><a href="global.html#statChanges">statChanges</a></li><li><a href="global.html#switchTab">switchTab</a></li><li><a href="global.html#symmetrizeData">symmetrizeData</a></li><li><a href="global.html#toDMSString">toDMSString</a></li><li><a href="global.html#updateAllBoats">updateAllBoats</a></li><li><a href="global.html#updateBindPopup">updateBindPopup</a></li><li><a href="global.html#updateBoatSelect">updateBoatSelect</a></li><li><a href="global.html#updateHeading">updateHeading</a></li><li><a href="global.html#updateIconStyle">updateIconStyle</a></li><li><a href="global.html#updateRouteDisplay">updateRouteDisplay</a></li><li><a href="global.html#updateStatusBar">updateStatusBar</a></li><li><a href="global.html#updateToolsVisibility">updateToolsVisibility</a></li><li><a href="global.html#updateWindyMap">updateWindyMap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue May 13 2025 23:41:58 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
