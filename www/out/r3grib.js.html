<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: r3grib.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: r3grib.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* jshint esversion: 6 */

/**
 * condense list of time stamps in concise way 
 * @param {Object} list of timesStamps
 */
function condenseTimeStamps (timeStamps) {
   let result = [];
   if (timeStamps.length === 0) return "[]";
   if (timeStamps.length &lt; 5) {
      for (let i = 0; i &lt; timeStamps.length; i++) {
         result.push (timeStamps [i]);
      }
      return "[" + result.join(", ") + "]";
   }

   let start = timeStamps[0];
   let prev = start;
   let timeStep = null;
   let diff = null;
   let afterStart = timeStamps [1];
   for (let i = 1; i &lt; timeStamps.length; i++) {
      diff = timeStamps[i] - prev;

      if (timeStep === null) {
         timeStep = diff; // Initialize first time step
      }

      if (diff !== timeStep) {
         // New sequence found
         if (prev !== start) {
            result.push(start + (prev !== start + timeStep ? ", " + afterStart + ".." + prev : ""));
            afterStart = start + diff;
         } else {
            result.push(start);
         }
         start = timeStamps[i];
         timeStep = diff;
      }

      prev = timeStamps[i];
   }
   afterStart = start + diff;

   // Add last segment
   if (prev !== start) {
      result.push(start + ", " + afterStart + ".." + prev);
   } else {
      result.push(start);
   }

   return "[" + result.join(", ") + "]";
}

/**
 * display meta information about remote grib file 
 * update gribLimits object 
 * @param {string} directory
 * @param {string} current grib name
 */
function gribInfo(dir, gribName) {
   const formData = `type=${REQ.GRIB}&amp;grib=${dir}/${gribName}`;
   console.log ("Request sent:", formData);
   const formatLat = x => (x &lt; 0) ? -x + "°S" : x + "°N";
   const formatLon = x => (x &lt; 0) ? -x + "°W" : x + "°E";

   fetch(apiUrl, {
      method: "POST",
      headers: {
         "Content-Type": "application/x-www-form-urlencoded"
      },
      body: formData
   })
   .then(response => {
      if (!response.ok) {
         throw new Error(`Error ${response.status}: ${response.statusText}`);
      }
      return response.json();
   })
   .then(data => {
      console.log ("JSON received:", JSON.stringify(data));
      if (Object.keys(data).length === 0) {
         Swal.fire({ icon: 'error', title: 'Error', text: 'Empty Grib or format error' });
         return;
      }

      if (dir === "grib") {
         gribLimits.bottomLat = data.bottomLat;
         gribLimits.leftLon = data.leftLon;
         gribLimits.topLat = data.topLat;
         gribLimits.rightLon = data.rightLon;
      }

      let shortNames = Array.isArray(data.shortNames) ? data.shortNames.join(", ") : "Not present";

      let rows = [
         ["Centre", `${data.centreName} (ID ${data.centreID})`],
         ["Time Run", `${data.runStart.slice(11, 13)}Z`],
         ["Window time UTC", `${data.runStart} - ${data.runEnd}`],
         ["File", `${data.fileName} (${data.fileSize.toLocaleString("fr-FR")} bytes)`],
         ["latStep / lonStep", `${data.latStep}° / ${data.lonStep}°`],
         ["Zone", `${data.nLat} x ${data.nLon} values: lat: ${formatLat (data.topLat)} to ${formatLat (data.bottomLat)}, lon: ${formatLon (data.leftLon)} to ${formatLon (data.rightLon)}`],
         ["Short Names", shortNames],
         ["Time Stamps", `${data.nTimeStamp} values: ${condenseTimeStamps(data.timeStamps)}`]
      ];
     if (data.Info.length >= 2) rows.push (["Info", `${data.Info}`]);

      const content = `
      &lt;div style="padding: 16px; font-family: Arial, sans-serif;">
         &lt;table style="border-collapse: collapse; width: 100%; text-align: left; font-size: 14px;">
            &lt;tbody>
               ${rows.map(([key, value], index) => `
                  &lt;tr style="background-color: ${index % 2 === 0 ? '#f9f9f9' : '#ffffff'}; text-align: left;" >
                     &lt;td style="padding: 8px 12px; font-weight: bold; border-bottom: 1px solid #ddd; text-align: left;" >${key}&lt;/td>
                     &lt;td style="padding: 8px 12px; border-bottom: 1px solid #ddd; text-align: left;" >${value}&lt;/td>
                  &lt;/tr>
               `).join('')}
            &lt;/tbody>
         &lt;/table>
      &lt;/div>`;

      Swal.fire({
         title: "Grib Info",
         html: content,
         icon: "success",
         confirmButtonText: "OK",
         width: "50%",
         confirmButtonColor: "#FFA500"
      });
   })
   .catch(error => {
      console.error("Error:", error);
      Swal.fire({
         title: "Error",
         text: error.message,
         icon: "error",
         confirmButtonText: "OK",
         confirmButtonColor: "#FFA500"
      });
   });
}

/**
 * choose a grib file then launch gribInfo 
 * @param {string} directory
 * @param {string} current grib name
 */
function chooseGrib (dir, fileName) {
   const formData = `type=${REQ.DIR}&amp;dir=${dir}`;
   console.log ("Reqquest sent:", formData);
   fetch(apiUrl, {
      method: "POST",
      headers: {
         "Content-Type": "application/x-www-form-urlencoded"
      },
      body: formData
   })
   .then(response => response.json())
   .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
         Swal.fire ("Error", "No Grib File found", "error");
         return;
      }

      // Création du menu déroulant SANS la taille et la date
      const fileOptions = data.map (file => {
         const selected = file[0] === fileName ? "selected" : "";
         return `&lt;option value="${file[0]}" ${selected}>${file[0]}&lt;/option>`;
      }).join("");
      // Dialog box display
      Swal.fire({
         title: "Grib Select",
         html: `
            &lt;div class="swal-wide">
               &lt;select id="gribSelect" class="swal2-select">
                  ${fileOptions}
               &lt;/select>
            &lt;/div>
         `,
         showCancelButton: true,
         confirmButtonText: "Confirm",
         cancelButtonText: "Cancel",
         customClass: { popup: "swal-wide" },
         preConfirm: () => {
         const selectedFile = document.getElementById ("gribSelect").value;
            if (!selectedFile) {
               Swal.showValidationMessage("Select file.");
            }
            return selectedFile;
         }
      }).then(result => {
         if (result.isConfirmed) {
            if (dir === "grib") {
               gribLimits.name = result.value; // update file selected for wind grib only
               drawGribLimits (gribLimits);
            }  
            else // current
               gribLimits.currentName = result.value;

            gribInfo (dir, result.value);
            updateStatusBar ();
            console.log ("gribLimits: " + gribLimits);
            let currentZoom = map.getZoom();
               map.setZoom (currentZoom - 1);
               setTimeout (() => {
               map.setZoom (currentZoom);
            }, 1000); // Merdique mais ça marche
         }
      });
   })
   .catch(error => {
      console.error("Error requesting grib:", error);
      Swal.fire("Erreur", "Impossible to get file list", "error");
   });
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addMarker">addMarker</a></li><li><a href="global.html#addPOI">addPOI</a></li><li><a href="global.html#addWaypoint">addWaypoint</a></li><li><a href="global.html#aisData">aisData</a></li><li><a href="global.html#aisDump">aisDump</a></li><li><a href="global.html#aisLayer">aisLayer</a></li><li><a href="global.html#backWard">backWard</a></li><li><a href="global.html#bestVmg">bestVmg</a></li><li><a href="global.html#bestVmgBack">bestVmgBack</a></li><li><a href="global.html#buildBodyRequest">buildBodyRequest</a></li><li><a href="global.html#button4POI">button4POI</a></li><li><a href="global.html#changeParam">changeParam</a></li><li><a href="global.html#chooseFile">chooseFile</a></li><li><a href="global.html#chooseGrib">chooseGrib</a></li><li><a href="global.html#choosePolar">choosePolar</a></li><li><a href="global.html#clearRoutes">clearRoutes</a></li><li><a href="global.html#closeContextMenu">closeContextMenu</a></li><li><a href="global.html#condenseTimeStamps">condenseTimeStamps</a></li><li><a href="global.html#createProgressBar">createProgressBar</a></li><li><a href="global.html#dateToStr">dateToStr</a></li><li><a href="global.html#deleteAllPOIs">deleteAllPOIs</a></li><li><a href="global.html#deleteCompetitor">deleteCompetitor</a></li><li><a href="global.html#deleteCompetitorByName">deleteCompetitorByName</a></li><li><a href="global.html#deletePOI">deletePOI</a></li><li><a href="global.html#dispAllCompetitors">dispAllCompetitors</a></li><li><a href="global.html#dispBestTimeHistogram">dispBestTimeHistogram</a></li><li><a href="global.html#displayWayPoints">displayWayPoints</a></li><li><a href="global.html#dmsToDecimal">dmsToDecimal</a></li><li><a href="global.html#downloadTextFile">downloadTextFile</a></li><li><a href="global.html#drawGribLimits">drawGribLimits</a></li><li><a href="global.html#drawOrtho">drawOrtho</a></li><li><a href="global.html#drawPolyline">drawPolyline</a></li><li><a href="global.html#dumpFile">dumpFile</a></li><li><a href="global.html#dumpIsoDesc">dumpIsoDesc</a></li><li><a href="global.html#dumpIsoc">dumpIsoc</a></li><li><a href="global.html#dumpRoute">dumpRoute</a></li><li><a href="global.html#epochToStrDate">epochToStrDate</a></li><li><a href="global.html#escapeHtml">escapeHtml</a></li><li><a href="global.html#fPenalty">fPenalty</a></li><li><a href="global.html#fPointLoss">fPointLoss</a></li><li><a href="global.html#fTimeToRecupOnePoint">fTimeToRecupOnePoint</a></li><li><a href="global.html#feedback">feedback</a></li><li><a href="global.html#fetchAisPosition">fetchAisPosition</a></li><li><a href="global.html#fetchGpsPosition">fetchGpsPosition</a></li><li><a href="global.html#finalUpdate">finalUpdate</a></li><li><a href="global.html#findBounds">findBounds</a></li><li><a href="global.html#findMaxSpeed">findMaxSpeed</a></li><li><a href="global.html#forWard">forWard</a></li><li><a href="global.html#formatDuration">formatDuration</a></li><li><a href="global.html#formatDurationShort">formatDurationShort</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLocalDate">formatLocalDate</a></li><li><a href="global.html#generatePolarPlotly">generatePolarPlotly</a></li><li><a href="global.html#getGreatCirclePath">getGreatCirclePath</a></li><li><a href="global.html#getLocalUtcOffsetInSeconds">getLocalUtcOffsetInSeconds</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getSerializablePOIs">getSerializablePOIs</a></li><li><a href="global.html#getServerInit">getServerInit</a></li><li><a href="global.html#getTextColorFromLuminance">getTextColorFromLuminance</a></li><li><a href="global.html#goBegin">goBegin</a></li><li><a href="global.html#gpsMarker">gpsMarker</a></li><li><a href="global.html#gpsPolyline">gpsPolyline</a></li><li><a href="global.html#gpsTrack">gpsTrack</a></li><li><a href="global.html#gribInfo">gribInfo</a></li><li><a href="global.html#handleRequest">handleRequest</a></li><li><a href="global.html#helpInfo">helpInfo</a></li><li><a href="global.html#importCSV">importCSV</a></li><li><a href="global.html#interpolate">interpolate</a></li><li><a href="global.html#interpolateSpeeds">interpolateSpeeds</a></li><li><a href="global.html#lastStepDurationFormatted">lastStepDurationFormatted</a></li><li><a href="global.html#latLonToStr">latLonToStr</a></li><li><a href="global.html#launchRouting">launchRouting</a></li><li><a href="global.html#loadAppState">loadAppState</a></li><li><a href="global.html#loxoCap">loxoCap</a></li><li><a href="global.html#loxoDist">loxoDist</a></li><li><a href="global.html#manageCompetitors">manageCompetitors</a></li><li><a href="global.html#move">move</a></li><li><a href="global.html#newCompetitor">newCompetitor</a></li><li><a href="global.html#orthoCap">orthoCap</a></li><li><a href="global.html#orthoDist">orthoDist</a></li><li><a href="global.html#parDump">parDump</a></li><li><a href="global.html#polarInfo">polarInfo</a></li><li><a href="global.html#popup4Comp">popup4Comp</a></li><li><a href="global.html#refreshMarker">refreshMarker</a></li><li><a href="global.html#removeCompetitor">removeCompetitor</a></li><li><a href="global.html#replay">replay</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#requestAllCompetitors">requestAllCompetitors</a></li><li><a href="global.html#requestBestTime">requestBestTime</a></li><li><a href="global.html#requestOne">requestOne</a></li><li><a href="global.html#resetWaypoint">resetWaypoint</a></li><li><a href="global.html#saveAppState">saveAppState</a></li><li><a href="global.html#setBoat">setBoat</a></li><li><a href="global.html#showAIS">showAIS</a></li><li><a href="global.html#showBoatPosition">showBoatPosition</a></li><li><a href="global.html#showContextMenu">showContextMenu</a></li><li><a href="global.html#showDestination">showDestination</a></li><li><a href="global.html#showInitMessage">showInitMessage</a></li><li><a href="global.html#showPOI">showPOI</a></li><li><a href="global.html#showPolarTable">showPolarTable</a></li><li><a href="global.html#showRoute">showRoute</a></li><li><a href="global.html#showRouteReport">showRouteReport</a></li><li><a href="global.html#showWayPoint">showWayPoint</a></li><li><a href="global.html#simplify">simplify</a></li><li><a href="global.html#stamina">stamina</a></li><li><a href="global.html#statChanges">statChanges</a></li><li><a href="global.html#switchTab">switchTab</a></li><li><a href="global.html#symmetrizeData">symmetrizeData</a></li><li><a href="global.html#toDMSString">toDMSString</a></li><li><a href="global.html#updateAllBoats">updateAllBoats</a></li><li><a href="global.html#updateBindPopup">updateBindPopup</a></li><li><a href="global.html#updateBoatSelect">updateBoatSelect</a></li><li><a href="global.html#updateHeading">updateHeading</a></li><li><a href="global.html#updateIconStyle">updateIconStyle</a></li><li><a href="global.html#updateRouteDisplay">updateRouteDisplay</a></li><li><a href="global.html#updateStatusBar">updateStatusBar</a></li><li><a href="global.html#updateToolsVisibility">updateToolsVisibility</a></li><li><a href="global.html#updateWindyMap">updateWindyMap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue May 13 2025 23:41:58 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
