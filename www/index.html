<!doctype html>
<html lang = "fr">
<head>
   <title>Rcube</title>
   <meta charset="UTF-8">
   <link rel="icon" type="image/ico" href="favicon.ico">

   <!-- CSS appli -->
   <link rel="stylesheet" type="text/css" href="css/r3.css">
   <link rel="stylesheet" type="text/css" href="css/r3par.css">
   <link rel="stylesheet" type="text/css" href="css/stamina.css">
   <link rel="stylesheet" type="text/css" href="css/launch.css">

   <!-- Font Awesome local -->
   <link rel="stylesheet" href="lib/fontawesome/all.min.css">

   <!-- Leaflet local (OSM + GeoJSON) -->
   <link rel="stylesheet" href="lib/leaflet/leaflet.css">

   <!-- Librairies JS locales -->
   <script src="lib/leaflet/leaflet.js"></script>
   <script src="lib/swal/sweetalert2.all.min.js"></script>
   <script src="lib/plotly/plotly-2.11.0.min.js"></script>

   <script src="js/init.js"></script>
   <script src="js/filedump.js"></script>
   <script src="js/r3grib.js"></script>
   <script src="js/r3polar.js"></script>
   <script src="js/r3waypoints.js"></script>
   <script src="js/r3displaycomp.js"></script>
   <script src="js/r3besttime.js"></script>
   <script src="js/r3routereport.js"></script>
   <script src="js/util.js"></script>
   <script src="js/r3util.js"></script>
   <script src="js/r3param.js"></script>
   <script src="js/r3par.js"></script>
   <script src="js/feedback.js"></script>
   <script src="js/stamina.js"></script>
   <script src="js/launch.js"></script>
   <script src="js/aisgps.js"></script>
   <script src="js/ports.js"></script>  
   <script src="js/ports4tide.js"></script>   
   <script src="js/showports.js"></script>
   <script src="js/polygons.js"></script>
   <script src="js/marks.js"></script>
   <script src="js/meters.js"></script>
   <script src="js/trace.js"></script>
   <script src="js/wind.js"></script>
   <script src="js/r3.js?v=0.2"></script>   
   <script src="js/twa.js"></script>
</head>
<body>
<div class="container">
   <header>
      <img src="favicon.ico" alt="favicon">
      <span>&nbsp;&nbsp;&nbsp;</span>
      <div class="dropdown">
         <button class="menu">Grib</button>
         <div class="dropdown-content">
            <button class="menu-link" onclick="selectModel ();">Grib Model  </button>
            <button class="menu-link" onclick="chooseGrib ('grib', gribLimits.name);">Grib  </button>
            <button class="menu-link" onclick="chooseGrib ('currentgrib', '');">Current</button>
            <button class="menu-link" onclick="gribCheck ();">Check</button>

         </div>
      </div>
      <div class="dropdown">
         <button class="menu">Polar</button>
         <div class="dropdown-content">
            <button class="menu-link" onclick="choosePolar ('pol', polarName);">Polar</button>
            <button class="menu-link" onclick="choosePolar ('wavepol', polWaveName);">Wave</button>
         </div>
      </div>
      <div class="dropdown">
         <button class="menu">Route</button>
         <div class="dropdown-content">
            <button class="menu-link" onclick="launchRouting ();">Launch</button>
            <button class="menu-link" onclick="launchRouteReport ();">Route Report</button>
            <button class="menu-link" onclick="dispBestTimeHistogram (bestTimeResult,initialStartTime,bestStartTime,routeParam.timeInterval);">Best Time Report </button>
            <button class="menu-link" onclick="dispAllCompetitors (compResult);">Benchmark Report</button>
            <button class="menu-link" onclick="launchTwaRouting ();">TWA Route</button>         
         </div>
      </div>
      <div class="dropdown">
         <button class="menu">Tech</button>
         <div class="dropdown-content">
            <button class="menu-link" onclick="manageWaypoints();">Manage Waypoints</button>            
            <button class="menu-link" onclick="displayWaypoints(competitors, myWayPoints);">Show Waypoints</button>
            <button class="menu-link" onclick="changeParam (routeParam);">Change</button>
            <button class="menu-link" onclick="manageCompetitors (competitors);">Manage Competitors</button>
            <button class="menu-link" onclick="showMarks(marks);">VR Marks show</button>
            <button class="menu-link" onclick="stamina ();">Stamina</button>
         </div>
      </div>
      <div class="dropdown">
         <button class="menu">â“˜ </button>
         <div class="dropdown-content">
            <a href="doc/Er3help.html" target="_blank">ðŸ‡¬ðŸ‡§ Help</a>
            <a href="doc/Fr3help.html" target="_blank">ðŸ‡«ðŸ‡· Aide</a>
            <button class="menu-link" onclick="helpInfo ();">About...</button>
            <button class="menu-link" onclick="feedback (apiUrl);">Feedback</button>
         </div>
      </div>
      <div class="dropdown">
         <button class="menu">ðŸ”—</button>
         <div class="dropdown-content">
            <button class="menu-link" onclick="openTide (0, competitors[0].lat, competitors[0].lon);">SHOM</button>
            <button class="menu-link" onclick="openTide (1, competitors[0].lat, competitors[0].lon);">MarÃ©e Info</button>
            <button class="menu-link" onclick="window.open (`https://meteofrance.com/isofronts`);">MÃ©tÃ©o France Map</button>
            <button class="menu-link" onclick="openWindy (competitors[0].lat, competitors[0].lon);">Windy</button>
            <button class="menu-link" onclick="showNoaaMapGif ();">NOAA Map</button>
            <button class="menu-link" onclick="window.open (`https://ocean.weather.gov/shtml/A_brief.php`);">NOAA Ocean</button>
            <button class="menu-link" onclick="openGoogleMaps(competitors[0].lat, competitors[0].lon)">GoogleMap</button>
            <button class="menu-link" onclick="openStreetMap(competitors[0].lat, competitors[0].lon)">OpenStreet</button>
            <button class="menu-link" onclick="openSeaMap(competitors[0].lat, competitors[0].lon)">OpenSeaMap</button>
         </div>
      </div>
      <div class="dropdown">
         <button class="menu" onclick="updateDMS ()" title="DMS Display">â˜°</button>
      </div>
      <div class="dropdown" id="devMenu" style="display: none;">
         <button class="menu">Developper</button>
         <div class="dropdown-content">
            <button class="menu-link" onclick="dumpIsoc (route);">Dump Isochrones</button>
            <button class="menu-link" onclick="dumpIsoDesc (route);">Dump IsoDesc</button>
            <button class="menu-link" onclick="parDump();">Par Dump</button>
            <button class="menu-link" onclick="chooseDumpFile ();">File Dump</button>
            <button class="menu-link" onclick="showGpxRoute();">GPX Route</button>
            <button class="menu-link" onclick="aisDump(aisData);">AIS Dump</button>
            <button class="menu-link" onclick="replay ();">Replay</button>
            <button class="menu-link" onclick="showTrace(map, myTrace);">Trace</button>
            <button class="menu-link" onclick="initServer();">ReInit</button>
            <button class="menu-link" onclick="dumpPorts(ports);">dump Ports</button>
            <a href="test.html" target="_blank">API Test</a>
            <a href="doc/clihelp.md" target="_blank">CLI Help</a>
            <a href="doc/README.md" target="_blank">README</a>
            <a href="doc/r3ServerTechDoc.html" target="_blank">Server side Tech Doc</a>
            <a href="doc/r3ClientTechDoc.html" target="_blank">Client side Tech Doc</a>
         </div>
      </div>
      <div class="dropdownRight">
         <button class="menu" id = "cadenas" onclick="promptForCreds()" title="Connexion">
             <i class="fas fa-user"></i> <i class="fas fa-lock"></i></button>
      </div>
   </header>

   <div id="windy">
   </div>
   <div id="spinnerOverlay" class="spinner-overlay">
      <div class="spinner"></div>
   </div>
   <div id="tools" style="display: none;">
      <button class="btn" onclick="goBegin();"><i class="fas fa-step-backward"></i></button>
      <button class="btn" onclick="backWard();"><i class="fas fa-backward"></i></button>
      <button class="btn" id="playPauseBtn" onclick="animation ? stopAnim(): playAnim()"> 
         <i id="playPauseIcon" class="fas fa-play"></i></button>
      <button class="btn" onclick="forWard();"><i class="fas fa-forward"></i></button>
      <button class="btn" onclick="goEnd();"><i class="fas fa-step-forward"></i></button>
      <button class="btn" onclick="clearRoutes();"><i class="fas fa-times"></i></button>
      <label for="timeLine">Time Line %</label>
      <input type="range" id="timeLine" min="1" max="100" value="1" oninput="updateTimeLine(this.value);">
      <span id="timeLineValue">001%</span>

      <span id="infoTime"></span>
      <span id= "isocCont" class="isocContainer">
         <label>
            Isoc <input type="checkbox" id="isocCheckbox" class="isocCheckbox" checked>
         </label>
         <label for="slider">Period</label>
         <input type="range" id="slider" min="1" max="20" value="1" oninput="updateValue(this.value);">
         <span id="sliderValue">1</span>
      </span>

      <script>      
         function updateTimeLine(val) {
            document.getElementById("timeLineValue").textContent = String(val).padStart(3, '0') + "%";
            const boatName = Object.keys(route)[0];  // Extract first key from response
            index = Math.round (val / 100 * (route[boatName].track.length - 1)); 
            console.log (`length: ${route[boatName].track.length}, index: ${index}`);
            if (route != null) {
               //updateWindyMap(route);
               updateAllBoats ();
            }
         }

         function updateValue(val) {
            document.getElementById("sliderValue").textContent = val;
            const isIsocChecked = document.getElementById("isocCheckbox").checked;
            moduloIsoc = isIsocChecked ? val : 0;
            if (route != null) {
               updateWindyMap(route);
               updateAllBoats ();
            }
         }

         document.getElementById("isocCheckbox").addEventListener("change", function() {
            const sliderVal = document.getElementById("slider").value;
            updateValue(sliderVal);
         });
   </script>
   </div> <!-- tools -->
   <footer class="footer">
      <span id = "infoRoute">Info</span>
      <span id="coords"> </span>
      <script>updateStatusBar ();</script>
   </footer>
</div>

<script>
   function launchRouteReport () {
      if (route === null) {
         Swal.fire ("No route", "", "warning");
         return;
      }
      if (routeParam.iBoat !== 0) {
         showRouteReport (route[competitors[Math.max(routeParam.iBoat - 1, 0)].name], DMSType);
      }
      else {
        const inputOptions = {};
        competitors.forEach((c, i) => {inputOptions[i] = c.name;});
        Swal.fire({
          title: "Choose competitor",
          showCancelButton: true,
          input: 'select',
          inputOptions: inputOptions,
          inputPlaceholder: 'Select a competitor',
        }).then((result) => {
          if (result.isConfirmed) {
            const i = parseInt(result.value, 10);   // competitor index
            console.log("Competitor", competitors[i].name);
            showRouteReport(route[competitors[i].name], DMSType);
          }
        });
      }
   }
   document.addEventListener('DOMContentLoaded', async () => {
      try {
         if (clearAppState) localStorage.clear(); else loadAppState ();
         mapMode = await chooseMapMode(mapMode);
         console.log('Selected map mode:', mapMode);
         saveAppState ();
         initMapAccordingToMode();
      } catch (e) {
         console.error('Error choosing map mode:', e);
         // fallback
         mapMode = MAP_MODE.LOCAL;
         initMapAccordingToMode();
      }
   });

   /* listen CTRL D to display developper menu */
   document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "d") {
         e.preventDefault(); // Ã©viter le marque-page sur certains navigateurs
         const menu = document.getElementById("devMenu");
         if (menu) {
            menu.style.display = (menu.style.display === "none") ? "inline-block" : "none";
         }
      }
   });

   function showNoaaMapGif() {
      Swal.fire({
         title: 'NOAA Map',
         html: `
            <img src="https://tgftp.nws.noaa.gov/fax/PYAA01.gif" alt="NOAA Map"
               style="transform: rotate(90deg); max-width: 90vh; max-height: 90vh;">
            `,
         width: 'auto',
         showCloseButton: true,
         showConfirmButton: false,
      });
   }

   function openTide(what, lat, lon) {
      let {idPort, namePort} = findNearestPort (lat, lon, ports4tide);
      const shomUrl = (what === 0) ? `https://maree.shom.fr/harbor/${namePort}`: `http://maree.info/${idPort}`;
      window.open(shomUrl, '_blank');
   }

   function openStreetMap(lat, lon) {
      const zoom = 10; // ajustable
      const url = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.02},${lat-0.02},${lon+0.02},${lat+0.02}&layer=mapnik&marker=${lat},${lon}`;
      window.open(url, '_blank');
   }

   function openSeaMap(lat, lon) {
      const zoom = 10;
      const url = `https://map.openseamap.org/?lat=${lat}&lon=${lon}&zoom=${zoom}`;
      window.open(url, '_blank');
   }

   function openWindy (lat, lon) {
      const url = `https://www.windy.com/${lat}/${lon}`;
      window.open(url, '_blank');
   }

   function openGoogleMaps(lat, lon) {
      const url = `https://www.google.com/maps/place/${lat},${lon}`;
      window.open(url, '_blank');
   }
</script>
</body>
</html>
