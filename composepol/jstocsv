#!/usr/bin/env bash
set -euo pipefail

json="${1:-/dev/stdin}"              # fichier en 1er arg, sinon stdin
idBoat="${2:-imoca_60_foils}"        # boat id en 2e arg (par défaut imoca_60_foils)

tmp=$(mktemp)

cat > "$tmp" <<'JQ'
.["data_" + $boat][0] as $b
| ($b.twa)  as $twa
| ($b.tws)  as $tws
| ($b.sail[] | select(.name == $sail) | .speed) as $spd
| (["twa"] + $tws) as $header
| [$header] + ( $twa | to_entries | map([.value] + ($spd[.key] // [])) )
| map( map(tostring) | join(";") )
| join("\n")
JQ

# Liste des voiles présentes et export CSV par voile
jq -r --arg boat "$idBoat" '.["data_" + $boat][0].sail[].name' "$json" \
| while IFS= read -r SAIL; do
  safe=${SAIL//[^[:alnum:]]/_}
  jq -r --arg sail "$SAIL" --arg boat "$idBoat" -f "$tmp" "$json" > "${idBoat}_${safe}.csv"
  echo "Écrit : ${idBoat}_${safe}.csv"
done
rm -f "$tmp"

